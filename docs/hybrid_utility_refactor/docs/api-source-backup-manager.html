<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SourceBackupManager API Documentation</title>
    <link rel="stylesheet" href="../css/design-system.css">
    <link rel="stylesheet" href="../css/main.css">
</head>
<body>
    <!-- Header -->
    <header class="site-header">
        <div class="container">
            <nav class="main-nav">
                <div class="logo">
                    <a href="../index.html">
                    <svg class="capcat-logo" width="100%" height="20" viewBox="0 0 120 36" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" xml:space="preserve">
                        <g transform="matrix(1,0,0,1,-25136.8,-9036.29)">
                                <g transform="matrix(0.101942,0,0,0.101942,24610.1,8883.85)">
                                    <path d="M5599.61,1616.47L5599.66,1616.38C5600.74,1622.26 5601.26,1628.65 5601.26,1635.54L5601.26,1701.4C5601.26,1704.57 5601.56,1707.02 5602.09,1708.92L5601.99,1709.02C5606.21,1723.62 5624.36,1704.6 5624.36,1723.41C5624.36,1732.23 5605.56,1747.52 5583.16,1745.91C5582.93,1745.92 5582.7,1745.92 5582.45,1745.92C5578.93,1745.92 5575.11,1745.16 5571.38,1743.78L5571.37,1743.78C5562.39,1740.41 5553.95,1733.47 5551.49,1724.98C5536.46,1738.54 5514.52,1747.96 5493.82,1749L5493.73,1749.09C5492.48,1749.15 5491.23,1749.18 5489.99,1749.18C5466.27,1749.18 5447.99,1732.07 5447.99,1707.96C5447.99,1707.61 5447.99,1707.26 5448,1706.91L5448.23,1706.74C5448.87,1663.44 5484.29,1647.39 5521.6,1642.33L5521.63,1642.29C5532.57,1640.82 5543.67,1640.29 5554.1,1640.29L5554.1,1618.51C5554.1,1614.47 5553.49,1610.72 5552.38,1607.31L5552.54,1607.1C5547.59,1592.27 5533.06,1583.85 5517.44,1585.07C5508.88,1585.74 5494.66,1592.62 5505.38,1603.35C5516.1,1614.07 5494.65,1633.45 5472.47,1628.01L5472.43,1628C5466.37,1626.51 5462.02,1621.44 5462.02,1611.33C5462.02,1589.79 5483.29,1578.82 5504.14,1573.64C5516.57,1570.55 5528.85,1569.51 5536.38,1569.51C5552,1569.51 5564.61,1572.36 5574.41,1577.84L5574.36,1577.94C5588.16,1585.72 5596.37,1598.77 5599.61,1616.47C5598.61,1618.1 5597.66,1619.69 5596.93,1620.96C5596.39,1621.89 5595.88,1622.76 5595.39,1623.58C5595.9,1622.73 5596.43,1621.84 5596.98,1620.88C5597.7,1619.62 5598.63,1618.07 5599.61,1616.47ZM5554.15,1674.61L5554.09,1674.68C5553.99,1671.49 5553.36,1668.44 5551.52,1665.83L5551.5,1665.79L5551.41,1665.68L5551.39,1665.65C5547.85,1660.68 5541.66,1659.07 5535.57,1658.92C5519.57,1658.53 5497.94,1661.21 5492.01,1680.51C5489.72,1687.93 5489.87,1697.98 5495.19,1706.19L5495.18,1706.19L5495.24,1706.28L5495.31,1706.37L5495.31,1706.37C5501.3,1714.11 5510.73,1717.92 5518.49,1717.88C5519.81,1717.87 5521.1,1717.78 5522.36,1717.61L5522.43,1717.52C5542.01,1714.91 5552.76,1693.79 5553.66,1683.39C5553.9,1680.5 5554.24,1677.5 5554.15,1674.61ZM5655.48,1606.94C5650.11,1592.14 5633.8,1610.33 5633.8,1591.19C5633.8,1582.01 5651.19,1565.8 5674.8,1568.98C5683.29,1569.97 5689.56,1573.73 5694.16,1578.52C5699.61,1584.19 5702.74,1591.31 5704.51,1596.99C5706.26,1602.63 5706.67,1606.85 5706.67,1606.85L5707.45,1606.85C5712.89,1587.4 5739.72,1569.51 5765.78,1569.51C5773.42,1569.51 5780.44,1570.87 5786.81,1573.3C5802.54,1579.32 5814.35,1591.95 5821.87,1607.23C5828.22,1620.14 5831.5,1634.93 5831.5,1649.24C5831.5,1656.97 5830.87,1664.41 5829.67,1671.48C5821.72,1718.11 5788.62,1749.18 5744.39,1749.18C5742.93,1749.18 5741.48,1749.14 5740.03,1749.07C5729.11,1748.48 5718.34,1745.59 5706.67,1739.07L5706.67,1762.41L5706.76,1762.37L5706.76,1774.83C5706.76,1776.77 5706.82,1778.53 5706.95,1780.11C5709.18,1808.27 5730.12,1782.01 5730.12,1803.7C5730.12,1812.89 5712.73,1829.1 5689.13,1825.92C5681.05,1824.97 5674.98,1822.11 5670.43,1818.32C5658.92,1808.73 5657.17,1793.24 5657.26,1788.05C5657.29,1785.83 5657.08,1783.58 5657.17,1781.4L5657.17,1620.07C5657.17,1614.05 5656.53,1609.85 5655.48,1606.94ZM5758.32,1602.3C5755.39,1601.38 5752.14,1600.88 5748.55,1600.88C5721.72,1600.88 5707.31,1633 5707.31,1659.84C5707.31,1664.6 5706.87,1673.25 5707.53,1682.86C5708.48,1696.5 5711.63,1712.06 5721.4,1721.14C5726.51,1725.9 5733.44,1728.88 5742.81,1728.88C5769.07,1728.88 5780.31,1701.62 5783.58,1676.51C5784.33,1670.76 5784.66,1665.12 5784.66,1659.94C5784.66,1638.52 5779.89,1609.05 5758.32,1602.3ZM5171.08,1669.46C5168.37,1658.28 5166.95,1646.44 5166.95,1634.13C5166.95,1610.06 5173.76,1587.85 5185.36,1568.57C5198.79,1546.25 5218.65,1527.87 5241.83,1515.1C5264.78,1502.45 5290.97,1495.32 5317.38,1495.32C5320.18,1495.32 5322.96,1495.45 5325.7,1495.71C5350.04,1497.99 5371.48,1509.87 5385.67,1521.82L5385.72,1521.75C5389.09,1524.58 5392.04,1527.42 5394.53,1530.14L5394.61,1530.18C5397.25,1533.07 5399.36,1535.82 5400.87,1538.27C5410.14,1553.33 5404.98,1573.26 5389.77,1581.12L5389.69,1581.13L5389.48,1581.3C5387.16,1582.47 5384.61,1583.36 5381.85,1583.91C5369.75,1586.33 5346.41,1584.08 5334.21,1555.59C5334.06,1555.23 5333.89,1554.86 5333.73,1554.5L5333.69,1554.53C5327.07,1540.04 5312.68,1525.35 5294.57,1522.11C5292.17,1521.68 5289.7,1521.45 5287.18,1521.45C5256.97,1521.45 5239.23,1548.98 5232.32,1579.7C5230.07,1589.73 5228.97,1600.11 5228.97,1609.97C5228.97,1629.41 5233.9,1648.72 5243.09,1665.52C5247.81,1674.17 5253.66,1682.15 5260.54,1689.14C5268.87,1697.6 5278.7,1704.62 5289.89,1709.63C5301.95,1715.03 5315.59,1718.1 5330.59,1718.1C5348.77,1718.1 5363.58,1713.34 5375.61,1707.41C5395.47,1697.63 5407.71,1684.66 5414.95,1684.66C5419.02,1684.66 5423.66,1688.72 5423.66,1692.21C5423.66,1716.94 5372.76,1752.65 5317.11,1761.57C5308.74,1762.91 5300.26,1763.64 5291.82,1763.64C5274.23,1763.64 5258.01,1760.54 5243.5,1754.83C5230.57,1749.76 5218.99,1742.62 5208.99,1733.79C5201.49,1727.17 5194.88,1719.59 5189.25,1711.21C5180.96,1698.87 5174.8,1684.79 5171.08,1669.46ZM5858.25,1647.84C5865.42,1607.08 5902.02,1576.76 5942.55,1570.55C5944.9,1570.19 5947.26,1569.91 5949.63,1569.72C5952.35,1569.49 5955.08,1569.38 5957.81,1569.38C5969.02,1569.38 5979.5,1572.6 5988.38,1577.1C6000.77,1583.39 6010.03,1592.2 6013.77,1598.28C6020.97,1609.97 6015.2,1626.02 6001.03,1628.85C5992.93,1630.47 5977.28,1628.96 5969.1,1609.87C5968.52,1608.51 5967.84,1607.14 5967.06,1605.8C5961.37,1595.95 5950.58,1586.9 5937.57,1586.9C5934.03,1586.9 5930.78,1587.45 5927.8,1588.47C5921.91,1590.48 5917.06,1594.31 5913.16,1599.32C5904.02,1611.07 5900.09,1629.27 5900.09,1645.62C5900.09,1656.62 5902.44,1667.56 5906.88,1677.48C5915.56,1696.86 5932.19,1712.35 5954.73,1716.8C5959.01,1717.65 5963.51,1718.1 5968.2,1718.10C5978.28,1718.1 5986.67,1715.97 5993.68,1713.05C6009.13,1706.61 6017.86,1696.29 6023.21,1696.29C6025.94,1696.29 6029.05,1699.01 6029.05,1701.35C6029.05,1717.25 5997.66,1739.92 5962.18,1747.02C5955.11,1748.44 5947.87,1749.23 5940.68,1749.23C5935.15,1749.23 5929.81,1748.77 5924.7,1747.89C5903.07,1744.15 5885.48,1732.81 5873.66,1716.57C5862.97,1701.87 5856.98,1683.15 5856.98,1662.42C5856.98,1657.43 5857.42,1652.57 5858.25,1647.84ZM6056.72,1728.59C6053.31,1722.59 6051.38,1715.5 6051.38,1707.68C6051.38,1662.41 6088.81,1646.4 6127.44,1641.7C6137.59,1640.46 6147.83,1640.01 6157.49,1640.01L6157.49,1618.23C6157.49,1614.6 6157,1611.2 6156.1,1608.07C6151.57,1592.47 6136.66,1583.53 6120.61,1584.79C6119.73,1584.86 6118.79,1584.99 6117.83,1585.18C6109.39,1586.91 6098.92,1593.44 6108.55,1603.06C6108.78,1603.3 6109,1603.53 6109.2,1603.77C6117.94,1614.13 6099.11,1631.45 6078.47,1628.29C6077.52,1628.15 6076.56,1627.95 6075.6,1627.72C6069.53,1626.22 6065.18,1621.16 6065.18,1611.05C6065.18,1580.13 6108.99,1571.01 6132.49,1569.48C6135.13,1569.31 6137.51,1569.23 6139.55,1569.23C6154.49,1569.23 6166.67,1571.83 6176.28,1576.85C6195.68,1586.99 6204.61,1606.99 6204.61,1635.34L6204.61,1701.21C6204.61,1708.61 6206.24,1712.14 6208.63,1713.74C6215.28,1718.16 6227.84,1707.63 6227.84,1723.27C6227.84,1732.09 6209.04,1747.39 6186.65,1745.78C6186.42,1745.79 6186.18,1745.79 6185.94,1745.79C6185.46,1745.79 6184.98,1745.77 6184.49,1745.75C6172.67,1745.07 6158.19,1736.37 6154.83,1724.79C6141.14,1737.14 6121.72,1746.06 6102.71,1748.33C6099.58,1748.7 6096.46,1748.9 6093.38,1748.9C6077.36,1748.9 6063.82,1741.09 6056.72,1728.59ZM6112.7,1662.32C6104.86,1665.41 6098.28,1670.86 6095.4,1680.23C6094.72,1682.43 6094.26,1684.86 6094.08,1687.41C6093.66,1693.45 6094.84,1700.13 6098.58,1705.91L6098.57,1705.91L6098.64,1706L6098.7,1706.09L6098.71,1706.09C6104.69,1713.83 6114.12,1717.63 6121.88,1717.6C6143.92,1717.48 6156.04,1694.27 6157,1683.19C6157.52,1677.12 6158.42,1670.53 6154.91,1665.54L6154.89,1665.51L6154.81,1665.39L6154.78,1665.36C6151.25,1660.4 6145.06,1658.79 6138.96,1658.64C6130.73,1658.44 6121.01,1659.05 6112.7,1662.32ZM6250.38,1599.35C6243.72,1597.06 6238.98,1592.74 6238.2,1585.08C6237.66,1579.82 6242.45,1574.94 6246.41,1573.75C6251.11,1572.34 6255.97,1571.79 6260.13,1572.06L6260.13,1568.57L6260.11,1568.57L6260.11,1552.35C6260.11,1552.35 6260.15,1552.37 6260.15,1552.35C6260.15,1537.61 6277.65,1516.47 6298.7,1513.73C6301.46,1513.39 6304.23,1514.26 6306.3,1516.11C6308.37,1517.97 6309.54,1520.63 6309.49,1523.42C6309.51,1526.69 6309.53,1530.53 6309.55,1534.49C6309.63,1547.47 6309.74,1561.74 6309.74,1561.74C6309.68,1562.93 6309.65,1564.21 6309.65,1565.58L6309.65,1568.57L6309.67,1568.57L6309.67,1575.96L6309.73,1575.97C6315.92,1576.58 6321.89,1574.97 6328.25,1573.92C6331.38,1573.4 6334.6,1573.02 6337.98,1573.1C6340.95,1573.17 6343.91,1575.81 6343.61,1579.03C6343.03,1585.23 6330.83,1597.16 6311.42,1599.51C6310.77,1602.68 6310.23,1605.22 6309.67,1607.42L6309.67,1654.6L6309.63,1654.58L6309.72,1699.33C6309.72,1709.22 6311.62,1714.47 6314.54,1717.03C6324,1725.32 6344.1,1705.13 6344.1,1722.65C6344.1,1731.83 6329.58,1749.33 6298.14,1749.33C6292.86,1749.33 6288.3,1748.79 6284.38,1747.85C6260.96,1742.22 6260.05,1722.04 6260.04,1714.17C6260.04,1713.55 6260.05,1713.01 6260.05,1712.55L6260.08,1671.95L6260.13,1601.31C6256.62,1600.98 6253.32,1600.36 6250.38,1599.35ZM5389.77,1581.29L5389.58,1581.39L5389.69,1581.3L5389.77,1581.29Z" style="fill:rgb(241,84,14);"></path>
                                </g>
                            </g>
                        </svg>
                    </a>
                </div>
                <ul class="nav-links">
                    <li><a href="../index.html#features" title="View Capcat features">Features</a></li>
                    <li><a href="../index.html#how-it-works" title="Learn how Capcat works">How It Works</a></li>
                    <li><a href="../index.html#tutorials" title="Browse Capcat tutorials">Tutorials</a></li>
                    <li><a href="https://substack.com/@yourusername/capcat-case-study" target="_blank" rel="noopener" title="Read the case study (opens in new window)">Case Study</a></li>
                    <li><a href="https://github.com/yourusername/capcat" class="btn-primary" title="Get started with Capcat on GitHub (opens in new window)" target="_blank" rel="noopener">Get Started</a></li>
                </ul>
                <button class="mobile-menu-toggle" aria-label="Toggle menu">
                    <span></span>
                    <span></span>
                    <span></span>
                </button>
            </nav>
        </div>
    </header>


    <div class="doc-container">
        <div class="container">
            <div class="doc-content">

<div class="nav-breadcrumb"><a href="index.html">Documentation Home</a></div>
<h1>SourceBackupManager API Documentation</h1>

<h2>Overview</h2>

<p>The <code>SourceBackupManager</code> provides automated backup and restore functionality for source configurations, enabling safe removal operations with undo capability.</p>

<h2>Module Location</h2>

<pre><code>from core.source_system.source_backup_manager import (
    SourceBackupManager,
    BackupMetadata,
    AlwaysBackupStrategy,
    NoBackupStrategy,
    ConditionalBackupStrategy
)
</code></pre>

<h2>Classes</h2>

<h3>BackupMetadata</h3>

<p>Dataclass containing metadata about a backup operation.</p>

<h4>Attributes:</h4>
<ul>
<li><code>backup_id: str</code> - Unique identifier (format: removal_YYYYMMDD_HHMMSS_microseconds)</li>
<li><code>timestamp: str</code> - ISO format timestamp of backup creation</li>
<li><code>sources: List[str]</code> - List of source IDs included in backup</li>
<li><code>backup_dir: Path</code> - Path to backup directory</li>
<li><code>bundle_backup: Optional[Path]</code> - Path to backed up bundles.yml (if exists)</li>
</ul>

<h4>Example:</h4>
<pre><code>metadata = BackupMetadata(
    backup_id=&quot;removal_20250118_143027_123456&quot;,
    timestamp=&quot;2025-01-18T14:30:27.123456&quot;,
    sources=[&quot;hn&quot;, &quot;bbc&quot;],
    backup_dir=Path(&quot;/path/to/.capcat_backups/removal_20250118_143027_123456&quot;),
    bundle_backup=Path(&quot;/path/to/.capcat_backups/removal_20250118_143027_123456/bundles.yml&quot;)
)
</code></pre>



<h3>SourceBackupManager</h3>

<p>Main class for managing source backups.</p>

<h3>Constructor</h3>

<pre><code>def __init__(self, backup_base_dir: Optional[Path] = None)
</code></pre>

<h4>Parameters:</h4>
<ul>
<li><code>backup_base_dir</code> - Base directory for backups (default: ../.capcat_backups)</li>
</ul>

<h4>Example:</h4>
<pre><code># Use default location
manager = SourceBackupManager()

# Custom location
manager = SourceBackupManager(Path(&quot;/custom/backup/path&quot;))
</code></pre>

<h3>Methods</h3>

<h5>create_backup()</h5>

<p>Create backup of sources before removal.</p>

<pre><code>def create_backup(
    self,
    source_ids: List[str],
    config_paths: List[Path],
    bundles_path: Path
) -&gt; BackupMetadata
</code></pre>

<h4>Parameters:</h4>
<ul>
<li><code>source_ids</code> - List of source IDs being backed up</li>
<li><code>config_paths</code> - Paths to source config files</li>
<li><code>bundles_path</code> - Path to bundles.yml file</li>
</ul>

<h4>Returns:</h4>
<ul>
<li><code>BackupMetadata</code> with backup information</li>
</ul>

<h4>Raises:</h4>
<ul>
<li><code>CapcatError</code> - If backup creation fails</li>
</ul>

<h4>Example:</h4>
<pre><code>metadata = manager.create_backup(
    source_ids=[&quot;hn&quot;, &quot;bbc&quot;],
    config_paths=[
        Path(&quot;sources/active/config_driven/configs/hn.yml&quot;),
        Path(&quot;sources/active/config_driven/configs/bbc.yml&quot;)
    ],
    bundles_path=Path(&quot;sources/active/bundles.yml&quot;)
)

print(f&quot;Backup created: {metadata.backup_id}&quot;)
# Output: Backup created: removal_20250118_143027_123456
</code></pre>

<h5>restore_backup()</h5>

<p>Restore sources from a backup.</p>

<pre><code>def restore_backup(
    self,
    backup_id: str,
    config_base_path: Path,
    bundles_path: Path
) -&gt; List[str]
</code></pre>

<h4>Parameters:</h4>
<ul>
<li><code>backup_id</code> - ID of backup to restore</li>
<li><code>config_base_path</code> - Base path for config files</li>
<li><code>bundles_path</code> - Path to bundles.yml file</li>
</ul>

<h4>Returns:</h4>
<ul>
<li>List of restored source IDs</li>
</ul>

<h4>Raises:</h4>
<ul>
<li><code>CapcatError</code> - If backup not found or restore fails</li>
</ul>

<h4>Example:</h4>
<pre><code>restored = manager.restore_backup(
    backup_id=&quot;removal_20250118_143027_123456&quot;,
    config_base_path=Path(&quot;sources/active/config_driven/configs&quot;),
    bundles_path=Path(&quot;sources/active/bundles.yml&quot;)
)

print(f&quot;Restored sources: {&#x27;, &#x27;.join(restored)}&quot;)
# Output: Restored sources: hn, bbc
</code></pre>

<h5>list_backups()</h5>

<p>List all available backups.</p>

<pre><code>def list_backups(self) -&gt; List[BackupMetadata]
</code></pre>

<h4>Returns:</h4>
<ul>
<li>List of BackupMetadata objects, sorted by timestamp</li>
</ul>

<h4>Example:</h4>
<pre><code>backups = manager.list_backups()

for backup in backups:
    print(f&quot;{backup.backup_id}: {len(backup.sources)} sources&quot;)
    print(f&quot;  Created: {backup.timestamp}&quot;)
    print(f&quot;  Sources: {&#x27;, &#x27;.join(backup.sources)}&quot;)
</code></pre>

<h5>delete_backup()</h5>

<p>Delete a specific backup.</p>

<pre><code>def delete_backup(self, backup_id: str) -&gt; None
</code></pre>

<h4>Parameters:</h4>
<ul>
<li><code>backup_id</code> - ID of backup to delete</li>
</ul>

<h4>Raises:</h4>
<ul>
<li><code>CapcatError</code> - If backup not found or deletion fails</li>
</ul>

<h4>Example:</h4>
<pre><code>manager.delete_backup(&quot;removal_20250118_143027_123456&quot;)
</code></pre>

<h5>cleanup_old_backups()</h5>

<p>Delete old backups, keeping only the most recent ones.</p>

<pre><code>def cleanup_old_backups(self, keep_count: int = 10) -&gt; int
</code></pre>

<h4>Parameters:</h4>
<ul>
<li><code>keep_count</code> - Number of recent backups to keep (default: 10)</li>
</ul>

<h4>Returns:</h4>
<ul>
<li>Number of backups deleted</li>
</ul>

<h4>Example:</h4>
<pre><code>deleted = manager.cleanup_old_backups(keep_count=5)
print(f&quot;Deleted {deleted} old backups&quot;)
# Output: Deleted 3 old backups
</code></pre>



<h3>Backup Strategies</h3>

<p>Protocol for implementing different backup strategies.</p>

<h3>BackupStrategy</h3>

<p>Base protocol.</p>

<pre><code>class BackupStrategy:
    def should_backup(self, source_ids: List[str]) -&gt; bool:
        ...
</code></pre>

<h3>AlwaysBackupStrategy</h3>

<p>Always create backups (recommended for production).</p>

<pre><code>strategy = AlwaysBackupStrategy()
if strategy.should_backup([&quot;hn&quot;, &quot;bbc&quot;]):
    # Create backup
    pass
</code></pre>

<h3>NoBackupStrategy</h3>

<p>Never create backups (for testing or forced removal).</p>

<pre><code>strategy = NoBackupStrategy()
if strategy.should_backup([&quot;hn&quot;, &quot;bbc&quot;]):
    # Will never execute
    pass
</code></pre>

<h3>ConditionalBackupStrategy</h3>

<p>Backup only if conditions are met.</p>

<pre><code>strategy = ConditionalBackupStrategy(min_sources=2)
if strategy.should_backup([&quot;hn&quot;]):  # False (only 1 source)
    pass
if strategy.should_backup([&quot;hn&quot;, &quot;bbc&quot;]):  # True (2 sources)
    pass
</code></pre>

<h2>Backup Structure</h2>

<p>Backups are stored with the following structure:</p>

<div class="ascii-art">.capcat_backups/
└── removal_20250118_143027_123456/
    ├── metadata.json           # Backup metadata
    ├── bundles.yml            # Backed up bundles file
    └── configs/               # Backed up config files
        ├── hn.yml
        └── bbc.yml
</div>

<h3>metadata.json Format</h3>

<pre><code>{
  &quot;backup_id&quot;: &quot;removal_20250118_143027_123456&quot;,
  &quot;timestamp&quot;: &quot;2025-01-18T14:30:27.123456&quot;,
  &quot;sources&quot;: [&quot;hn&quot;, &quot;bbc&quot;],
  &quot;bundle_backup&quot;: &quot;/path/to/bundles.yml&quot;
}
</code></pre>

<h2>Usage Examples</h2>

<h3>Complete Backup/Restore Workflow</h3>

<pre><code>from pathlib import Path
from core.source_system.source_backup_manager import SourceBackupManager

# Initialize manager
manager = SourceBackupManager()

# Create backup before removal
metadata = manager.create_backup(
    source_ids=[&quot;hn&quot;, &quot;bbc&quot;],
    config_paths=[
        Path(&quot;sources/active/config_driven/configs/hn.yml&quot;),
        Path(&quot;sources/active/config_driven/configs/bbc.yml&quot;)
    ],
    bundles_path=Path(&quot;sources/active/bundles.yml&quot;)
)

print(f&quot;Backup created: {metadata.backup_id}&quot;)

# ... perform removal operations ...

# Restore if needed
restored_sources = manager.restore_backup(
    backup_id=metadata.backup_id,
    config_base_path=Path(&quot;sources/active/config_driven/configs&quot;),
    bundles_path=Path(&quot;sources/active/bundles.yml&quot;)
)

print(f&quot;Restored: {restored_sources}&quot;)
</code></pre>

<h3>Listing and Managing Backups</h3>

<pre><code># List all backups
backups = manager.list_backups()

print(f&quot;Total backups: {len(backups)}&quot;)

# Show details
for backup in backups:
    age_days = (datetime.now() - datetime.fromisoformat(backup.timestamp)).days
    print(f&quot;{backup.backup_id}: {len(backup.sources)} sources, {age_days} days old&quot;)

# Clean up old backups
deleted = manager.cleanup_old_backups(keep_count=5)
print(f&quot;Cleaned up {deleted} old backups&quot;)
</code></pre>

<h3>Conditional Backup</h3>

<pre><code>from core.source_system.source_backup_manager import ConditionalBackupStrategy

strategy = ConditionalBackupStrategy(min_sources=2)

sources_to_remove = [&quot;hn&quot;, &quot;bbc&quot;]

if strategy.should_backup(sources_to_remove):
    metadata = manager.create_backup(
        source_ids=sources_to_remove,
        config_paths=[...],
        bundles_path=Path(&quot;...&quot;)
    )
    print(f&quot;Backup created: {metadata.backup_id}&quot;)
else:
    print(&quot;Skipping backup (not enough sources)&quot;)
</code></pre>

<h2>Error Handling</h2>

<pre><code>from core.exceptions import CapcatError

try:
    metadata = manager.create_backup(
        source_ids=[&quot;hn&quot;],
        config_paths=[Path(&quot;nonexistent.yml&quot;)],
        bundles_path=Path(&quot;bundles.yml&quot;)
    )
except CapcatError as e:
    print(f&quot;Backup failed: {e}&quot;)
    # Handle error appropriately

try:
    restored = manager.restore_backup(
        backup_id=&quot;nonexistent_backup&quot;,
        config_base_path=Path(&quot;configs&quot;),
        bundles_path=Path(&quot;bundles.yml&quot;)
    )
except CapcatError as e:
    print(f&quot;Restore failed: {e}&quot;)
    # Backup not found
</code></pre>

<h2>Best Practices</h2>

<ol>
<li><h4>Always Create Backups</h4> - Use <code>AlwaysBackupStrategy</code> in production</li>
<li><h4>Regular Cleanup</h4> - Run <code>cleanup_old_backups()</code> periodically</li>
<li><h4>Verify Before Removal</h4> - Check backup success before deleting sources</li>
<li><h4>Handle Missing Files</h4> - Backup succeeds even if config files don&#x27;t exist</li>
<li><h4>Store Backup IDs</h4> - Save backup_id for potential undo operations</li>
</ol>

<h2>Thread Safety</h2>

<p>The <code>SourceBackupManager</code> is not thread-safe. For concurrent access:</p>
<ul>
<li>Use file locking mechanisms</li>
<li>Implement single-writer pattern</li>
<li>Queue backup operations</li>
</ul>

<h2>Performance Considerations</h2>

<ul>
<li>Backup creation is I/O bound (file copy operations)</li>
<li>Average backup time: ~10-50ms depending on file sizes</li>
<li>List operations read metadata files sequentially</li>
<li>Cleanup operations use bulk deletion for efficiency</li>
</ul>

<h2>Integration with Remove Command</h2>

<pre><code>from core.source_system.remove_source_command import RemoveSourceCommand
from core.source_system.source_backup_manager import SourceBackupManager

# Create backup manager
backup_manager = SourceBackupManager()

# Backup before removal
metadata = backup_manager.create_backup(
    source_ids=selected_sources,
    config_paths=config_paths,
    bundles_path=bundles_path
)

# Perform removal
command.execute()

# Undo if needed
if need_undo:
    backup_manager.restore_backup(
        backup_id=metadata.backup_id,
        config_base_path=config_base_path,
        bundles_path=bundles_path
    )
</code></pre>

<h2>Testing</h2>

<p>See <code>tests/test_source_backup_manager.py</code> for comprehensive test examples.</p>

<h2>See Also</h2>

<ul>
<li><a href="api-source-analytics.html">Source Analytics API</a></li>
<li><a href="api-remove-source-command.html">Remove Source Command API</a></li>
<li><a href="TESTING-REMOVE-SOURCE.html">Testing Guide</a></li>
</ul>


<script type="module">
  import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
    mermaid.initialize({
    startOnLoad: true,
    theme: 'base',
    themeVariables: {
      // Primary colors from design system (Capcat orange palette)
      primaryColor: '#FFD4B7',           // --orange-200
      primaryTextColor: '#201419',       // --ink
      primaryBorderColor: '#F1540E',     // --orange-500 / --accent-primary

      // Line and edge colors
      lineColor: '#58444c',              // --ink-medium

      // Secondary colors
      secondaryColor: '#FFEADB',         // --orange-100
      tertiaryColor: '#f9f8ed',          // --accent-cream-primary

      // Text colors
      textColor: '#201419',              // --ink
      mainBkg: '#FAF8EE',                // --cream

      // Node styling
      nodeBorder: '#F1540E',             // --accent-primary
      clusterBkg: '#faf2e7',             // --accent-cream-light
      clusterBorder: '#D44400',          // --orange-600 / --accent-hover

      // Font
      fontFamily: '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif',
      fontSize: '16px'
    },
    flowchart: {
      nodeSpacing: 50,
      rankSpacing: 50,
      padding: 15,
      useMaxWidth: true,
      htmlLabels: true,
      curve: 'basis'
    }
  });

  // Add copy buttons to Mermaid diagrams after rendering
  document.addEventListener('DOMContentLoaded', function() {
    const mermaidDivs = document.querySelectorAll('.mermaid');

    mermaidDivs.forEach(function(mermaidDiv) {
      // Get the original Mermaid source code
      const mermaidSource = mermaidDiv.textContent;

      // Create container wrapper
      const container = document.createElement('div');
      container.className = 'mermaid-container';

      // Create copy button
      const copyBtn = document.createElement('button');
      copyBtn.className = 'mermaid-copy-btn';
      copyBtn.textContent = 'Copy Mermaid Code';
      copyBtn.setAttribute('title', 'Copy diagram code for Draw.io, Mermaid Live, etc.');

      copyBtn.addEventListener('click', function() {
        navigator.clipboard.writeText(mermaidSource).then(function() {
          copyBtn.textContent = 'Copied!';
          copyBtn.classList.add('copied');

          setTimeout(function() {
            copyBtn.textContent = 'Copy Mermaid Code';
            copyBtn.classList.remove('copied');
          }, 2000);
        });
      });

      // Wrap the mermaid div in container and add button
      mermaidDiv.parentNode.insertBefore(container, mermaidDiv);
      container.appendChild(mermaidDiv);
      container.appendChild(copyBtn);
    });
  });
</script>
    <script src="../js/main.js"></script>

            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="site-footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-logo">
                    <svg class="capcat-logo" viewBox="0 0 120 36" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" xml:space="preserve">
                        <g transform="matrix(1,0,0,1,-25136.8,-9036.29)">
                                <g transform="matrix(0.101942,0,0,0.101942,24610.1,8883.85)">
                                    <path d="M5599.61,1616.47L5599.66,1616.38C5600.74,1622.26 5601.26,1628.65 5601.26,1635.54L5601.26,1701.4C5601.26,1704.57 5601.56,1707.02 5602.09,1708.92L5601.99,1709.02C5606.21,1723.62 5624.36,1704.6 5624.36,1723.41C5624.36,1732.23 5605.56,1747.52 5583.16,1745.91C5582.93,1745.92 5582.7,1745.92 5582.45,1745.92C5578.93,1745.92 5575.11,1745.16 5571.38,1743.78L5571.37,1743.78C5562.39,1740.41 5553.95,1733.47 5551.49,1724.98C5536.46,1738.54 5514.52,1747.96 5493.82,1749L5493.73,1749.09C5492.48,1749.15 5491.23,1749.18 5489.99,1749.18C5466.27,1749.18 5447.99,1732.07 5447.99,1707.96C5447.99,1707.61 5447.99,1707.26 5448,1706.91L5448.23,1706.74C5448.87,1663.44 5484.29,1647.39 5521.6,1642.33L5521.63,1642.29C5532.57,1640.82 5543.67,1640.29 5554.1,1640.29L5554.1,1618.51C5554.1,1614.47 5553.49,1610.72 5552.38,1607.31L5552.54,1607.1C5547.59,1592.27 5533.06,1583.85 5517.44,1585.07C5508.88,1585.74 5494.66,1592.62 5505.38,1603.35C5516.1,1614.07 5494.65,1633.45 5472.47,1628.01L5472.43,1628C5466.37,1626.51 5462.02,1621.44 5462.02,1611.33C5462.02,1589.79 5483.29,1578.82 5504.14,1573.64C5516.57,1570.55 5528.85,1569.51 5536.38,1569.51C5552,1569.51 5564.61,1572.36 5574.41,1577.84L5574.36,1577.94C5588.16,1585.72 5596.37,1598.77 5599.61,1616.47C5598.61,1618.1 5597.66,1619.69 5596.93,1620.96C5596.39,1621.89 5595.88,1622.76 5595.39,1623.58C5595.9,1622.73 5596.43,1621.84 5596.98,1620.88C5597.7,1619.62 5598.63,1618.07 5599.61,1616.47ZM5554.15,1674.61L5554.09,1674.68C5553.99,1671.49 5553.36,1668.44 5551.52,1665.83L5551.5,1665.79L5551.41,1665.68L5551.39,1665.65C5547.85,1660.68 5541.66,1659.07 5535.57,1658.92C5519.57,1658.53 5497.94,1661.21 5492.01,1680.51C5489.72,1687.93 5489.87,1697.98 5495.19,1706.19L5495.18,1706.19L5495.24,1706.28L5495.31,1706.37L5495.31,1706.37C5501.3,1714.11 5510.73,1717.92 5518.49,1717.88C5519.81,1717.87 5521.1,1717.78 5522.36,1717.61L5522.43,1717.52C5542.01,1714.91 5552.76,1693.79 5553.66,1683.39C5553.9,1680.5 5554.24,1677.5 5554.15,1674.61ZM5655.48,1606.94C5650.11,1592.14 5633.8,1610.33 5633.8,1591.19C5633.8,1582.01 5651.19,1565.8 5674.8,1568.98C5683.29,1569.97 5689.56,1573.73 5694.16,1578.52C5699.61,1584.19 5702.74,1591.31 5704.51,1596.99C5706.26,1602.63 5706.67,1606.85 5706.67,1606.85L5707.45,1606.85C5712.89,1587.4 5739.72,1569.51 5765.78,1569.51C5773.42,1569.51 5780.44,1570.87 5786.81,1573.3C5802.54,1579.32 5814.35,1591.95 5821.87,1607.23C5828.22,1620.14 5831.5,1634.93 5831.5,1649.24C5831.5,1656.97 5830.87,1664.41 5829.67,1671.48C5821.72,1718.11 5788.62,1749.18 5744.39,1749.18C5742.93,1749.18 5741.48,1749.14 5740.03,1749.07C5729.11,1748.48 5718.34,1745.59 5706.67,1739.07L5706.67,1762.41L5706.76,1762.37L5706.76,1774.83C5706.76,1776.77 5706.82,1778.53 5706.95,1780.11C5709.18,1808.27 5730.12,1782.01 5730.12,1803.7C5730.12,1812.89 5712.73,1829.1 5689.13,1825.92C5681.05,1824.97 5674.98,1822.11 5670.43,1818.32C5658.92,1808.73 5657.17,1793.24 5657.26,1788.05C5657.29,1785.83 5657.08,1783.58 5657.17,1781.4L5657.17,1620.07C5657.17,1614.05 5656.53,1609.85 5655.48,1606.94ZM5758.32,1602.3C5755.39,1601.38 5752.14,1600.88 5748.55,1600.88C5721.72,1600.88 5707.31,1633 5707.31,1659.84C5707.31,1664.6 5706.87,1673.25 5707.53,1682.86C5708.48,1696.5 5711.63,1712.06 5721.4,1721.14C5726.51,1725.9 5733.44,1728.88 5742.81,1728.88C5769.07,1728.88 5780.31,1701.62 5783.58,1676.51C5784.33,1670.76 5784.66,1665.12 5784.66,1659.94C5784.66,1638.52 5779.89,1609.05 5758.32,1602.3ZM5171.08,1669.46C5168.37,1658.28 5166.95,1646.44 5166.95,1634.13C5166.95,1610.06 5173.76,1587.85 5185.36,1568.57C5198.79,1546.25 5218.65,1527.87 5241.83,1515.1C5264.78,1502.45 5290.97,1495.32 5317.38,1495.32C5320.18,1495.32 5322.96,1495.45 5325.7,1495.71C5350.04,1497.99 5371.48,1509.87 5385.67,1521.82L5385.72,1521.75C5389.09,1524.58 5392.04,1527.42 5394.53,1530.14L5394.61,1530.18C5397.25,1533.07 5399.36,1535.82 5400.87,1538.27C5410.14,1553.33 5404.98,1573.26 5389.77,1581.12L5389.69,1581.13L5389.48,1581.3C5387.16,1582.47 5384.61,1583.36 5381.85,1583.91C5369.75,1586.33 5346.41,1584.08 5334.21,1555.59C5334.06,1555.23 5333.89,1554.86 5333.73,1554.5L5333.69,1554.53C5327.07,1540.04 5312.68,1525.35 5294.57,1522.11C5292.17,1521.68 5289.7,1521.45 5287.18,1521.45C5256.97,1521.45 5239.23,1548.98 5232.32,1579.7C5230.07,1589.73 5228.97,1600.11 5228.97,1609.97C5228.97,1629.41 5233.9,1648.72 5243.09,1665.52C5247.81,1674.17 5253.66,1682.15 5260.54,1689.14C5268.87,1697.6 5278.7,1704.62 5289.89,1709.63C5301.95,1715.03 5315.59,1718.1 5330.59,1718.1C5348.77,1718.1 5363.58,1713.34 5375.61,1707.41C5395.47,1697.63 5407.71,1684.66 5414.95,1684.66C5419.02,1684.66 5423.66,1688.72 5423.66,1692.21C5423.66,1716.94 5372.76,1752.65 5317.11,1761.57C5308.74,1762.91 5300.26,1763.64 5291.82,1763.64C5274.23,1763.64 5258.01,1760.54 5243.5,1754.83C5230.57,1749.76 5218.99,1742.62 5208.99,1733.79C5201.49,1727.17 5194.88,1719.59 5189.25,1711.21C5180.96,1698.87 5174.8,1684.79 5171.08,1669.46ZM5858.25,1647.84C5865.42,1607.08 5902.02,1576.76 5942.55,1570.55C5944.9,1570.19 5947.26,1569.91 5949.63,1569.72C5952.35,1569.49 5955.08,1569.38 5957.81,1569.38C5969.02,1569.38 5979.5,1572.6 5988.38,1577.1C6000.77,1583.39 6010.03,1592.2 6013.77,1598.28C6020.97,1609.97 6015.2,1626.02 6001.03,1628.85C5992.93,1630.47 5977.28,1628.96 5969.1,1609.87C5968.52,1608.51 5967.84,1607.14 5967.06,1605.8C5961.37,1595.95 5950.58,1586.9 5937.57,1586.9C5934.03,1586.9 5930.78,1587.45 5927.8,1588.47C5921.91,1590.48 5917.06,1594.31 5913.16,1599.32C5904.02,1611.07 5900.09,1629.27 5900.09,1645.62C5900.09,1656.62 5902.44,1667.56 5906.88,1677.48C5915.56,1696.86 5932.19,1712.35 5954.73,1716.8C5959.01,1717.65 5963.51,1718.1 5968.2,1718.1C5978.28,1718.1 5986.67,1715.97 5993.68,1713.05C6009.13,1706.61 6017.86,1696.29 6023.21,1696.29C6025.94,1696.29 6029.05,1699.01 6029.05,1701.35C6029.05,1717.25 5997.66,1739.92 5962.18,1747.02C5955.11,1748.44 5947.87,1749.23 5940.68,1749.23C5935.15,1749.23 5929.81,1748.77 5924.7,1747.89C5903.07,1744.15 5885.48,1732.81 5873.66,1716.57C5862.97,1701.87 5856.98,1683.15 5856.98,1662.42C5856.98,1657.43 5857.42,1652.57 5858.25,1647.84ZM6056.72,1728.59C6053.31,1722.59 6051.38,1715.5 6051.38,1707.68C6051.38,1662.41 6088.81,1646.4 6127.44,1641.7C6137.59,1640.46 6147.83,1640.01 6157.49,1640.01L6157.49,1618.23C6157.49,1614.6 6157,1611.2 6156.1,1608.07C6151.57,1592.47 6136.66,1583.53 6120.61,1584.79C6119.73,1584.86 6118.79,1584.99 6117.83,1585.18C6109.39,1586.91 6098.92,1593.44 6108.55,1603.06C6108.78,1603.3 6109,1603.53 6109.2,1603.77C6117.94,1614.13 6099.11,1631.45 6078.47,1628.29C6077.52,1628.15 6076.56,1627.95 6075.6,1627.72C6069.53,1626.22 6065.18,1621.16 6065.18,1611.05C6065.18,1580.13 6108.99,1571.01 6132.49,1569.48C6135.13,1569.31 6137.51,1569.23 6139.55,1569.23C6154.49,1569.23 6166.67,1571.83 6176.28,1576.85C6195.68,1586.99 6204.61,1606.99 6204.61,1635.34L6204.61,1701.21C6204.61,1708.61 6206.24,1712.14 6208.63,1713.74C6215.28,1718.16 6227.84,1707.63 6227.84,1723.27C6227.84,1732.09 6209.04,1747.39 6186.65,1745.78C6186.42,1745.79 6186.18,1745.79 6185.94,1745.79C6185.46,1745.79 6184.98,1745.77 6184.49,1745.75C6172.67,1745.07 6158.19,1736.37 6154.83,1724.79C6141.14,1737.14 6121.72,1746.06 6102.71,1748.33C6099.58,1748.7 6096.46,1748.9 6093.38,1748.9C6077.36,1748.9 6063.82,1741.09 6056.72,1728.59ZM6112.7,1662.32C6104.86,1665.41 6098.28,1670.86 6095.4,1680.23C6094.72,1682.43 6094.26,1684.86 6094.08,1687.41C6093.66,1693.45 6094.84,1700.13 6098.58,1705.91L6098.57,1705.91L6098.64,1706L6098.7,1706.09L6098.71,1706.09C6104.69,1713.83 6114.12,1717.63 6121.88,1717.6C6143.92,1717.48 6156.04,1694.27 6157,1683.19C6157.52,1677.12 6158.42,1670.53 6154.91,1665.54L6154.89,1665.51L6154.81,1665.39L6154.78,1665.36C6151.25,1660.4 6145.06,1658.79 6138.96,1658.64C6130.73,1658.44 6121.01,1659.05 6112.7,1662.32ZM6250.38,1599.35C6243.72,1597.06 6238.98,1592.74 6238.2,1585.08C6237.66,1579.82 6242.45,1574.94 6246.41,1573.75C6251.11,1572.34 6255.97,1571.79 6260.13,1572.06L6260.13,1568.57L6260.11,1568.57L6260.11,1552.35C6260.11,1552.35 6260.15,1552.37 6260.15,1552.35C6260.15,1537.61 6277.65,1516.47 6298.7,1513.73C6301.46,1513.39 6304.23,1514.26 6306.3,1516.11C6308.37,1517.97 6309.54,1520.63 6309.49,1523.42C6309.51,1526.69 6309.53,1530.53 6309.55,1534.49C6309.63,1547.47 6309.74,1561.74 6309.74,1561.74C6309.68,1562.93 6309.65,1564.21 6309.65,1565.58L6309.65,1568.57L6309.67,1568.57L6309.67,1575.96L6309.73,1575.97C6315.92,1576.58 6321.89,1574.97 6328.25,1573.92C6331.38,1573.4 6334.6,1573.02 6337.98,1573.1C6340.95,1573.17 6343.91,1575.81 6343.61,1579.03C6343.03,1585.23 6330.83,1597.16 6311.42,1599.51C6310.77,1602.68 6310.23,1605.22 6309.67,1607.42L6309.67,1654.6L6309.63,1654.58L6309.72,1699.33C6309.72,1709.22 6311.62,1714.47 6314.54,1717.03C6324,1725.32 6344.1,1705.13 6344.1,1722.65C6344.1,1731.83 6329.58,1749.33 6298.14,1749.33C6292.86,1749.33 6288.3,1748.79 6284.38,1747.85C6260.96,1742.22 6260.05,1722.04 6260.04,1714.17C6260.04,1713.55 6260.05,1713.01 6260.05,1712.55L6260.08,1671.95L6260.13,1601.31C6256.62,1600.98 6253.32,1600.36 6250.38,1599.35ZM5389.77,1581.29L5389.58,1581.39L5389.69,1581.3L5389.77,1581.29Z" style="fill:rgb(241,84,14);"></path>
                                </g>
                            </g>
                        </svg>
                </div>

                <div class="footer-links">
                    <div class="footer-column">
                        <h3>Documentation</h3>
                        <ul>
                            <li><a href="../docs/quick-start.html" title="Quick start guide">Quick Start</a></li>
                            <li><a href="../docs/architecture.html" title="System architecture">Architecture</a></li>
                            <li><a href="../docs/source-development.html" title="Develop custom sources">Source Development</a></li>                        </ul>
                    </div>

                    <div class="footer-column">
                        <h3>Resources</h3>
                        <ul>
                            <li><a href="../docs/tutorials/index.html" title="Browse tutorials">Tutorials</a></li>
                            <li><a href="https://github.com/yourusername/capcat" title="View on GitHub (opens in new window)" target="_blank" rel="noopener">GitHub</a></li>
                            <li><a href="https://github.com/yourusername/capcat/issues" title="Report issues (opens in new window)" target="_blank" rel="noopener">Issues</a></li>
                        </ul>
                    </div>

                    <div class="footer-column">
                        <h3>About</h3>
                        <ul>
                            <li><a href="https://stayux.substack.com" target="_blank" rel="noopener" title="Designer blog (opens in new window)">Designer Blog</a></li>
                            <li><a href="ethical-scraping.html" title="Ethical scraping guidelines">Ethical Scraping</a></li>
                            <li><a href="https://github.com/yourusername/capcat/blob/main/LICENSE" title="View license (opens in new window)" target="_blank" rel="noopener">License</a></li>
                        </ul>
                    </div>
                </div>
            </div>

            <div class="footer-credit">
                <p>Design, illustration and context engineering by <a href="https://stayux.com" title="Visit Stayux.com (opens in new window)" target="_blank" rel="noopener">Stayu Kasabov | Stayux.com</a></p>
                <p>NLP driven and LLM generated MVP</p>
            </div>
        </div>
    </footer>

    <!-- Back to Top Button -->
    <button id="backToTopBtn" title="Go to top">
        <svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 0 24 24" width="24">
            <path d="M0 0h24v24H0V0z" fill="none"/>
            <path fill="currentColor" d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6 1.41 1.41z"/>
        </svg>
    </button>

</body>
