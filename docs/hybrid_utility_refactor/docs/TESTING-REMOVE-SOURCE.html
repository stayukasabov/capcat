<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Testing Guide: Enhanced Remove-Source</title>
    <link rel="stylesheet" href="../css/design-system.css">
    <link rel="stylesheet" href="../css/main.css">
</head>
<body>
    <!-- Header -->
    <div id="header-placeholder"></div>


    <div class="doc-container">
        <div class="container">
            <div class="doc-content">

<div class="nav-breadcrumb"><a href="index.html">Documentation Home</a></div>
<h1>Testing Guide: Enhanced Remove-Source</h1>

<h2>Quick Test (5 minutes)</h2>

<h3>Prerequisites</h3>
<pre><code>cd Application
source venv/bin/activate
</code></pre>

<h3>1. Create Test Sources</h3>
<pre><code># Add a test source
./capcat add-source --url https://feeds.arstechnica.com/arstechnica/index

# Follow prompts to add source ID: test_source1
</code></pre>

<h3>2. Test Dry-Run</h3>
<pre><code>./capcat remove-source --dry-run

# Expected:
# - Shows analytics (if you&#x27;ve used sources)
# - Select test_source1
# - Shows removal summary
# - Message: &quot;[DRY RUN] No changes made&quot;
# - Source still exists after
</code></pre>

<h3>3. Test Actual Removal</h3>
<pre><code>./capcat remove-source

# Expected:
# - Shows analytics
# - Select test_source1
# - Shows removal summary
# - Confirm: Yes
# - Message: &quot;Successfully removed 1 source(s)&quot;
# - Message: &quot;Backup created: removal_YYYYMMDD_HHMMSS&quot;
</code></pre>

<h3>4. Verify Removal</h3>
<pre><code>./capcat list sources

# Expected:
# - test_source1 NOT in list
</code></pre>

<h3>5. Test Undo</h3>
<pre><code>./capcat remove-source --undo

# Expected:
# - Shows list of backups
# - Select most recent
# - Confirm: Yes
# - Message: &quot;Restored 1 source(s): test_source1&quot;
</code></pre>

<h3>6. Verify Restore</h3>
<pre><code>./capcat list sources

# Expected:
# - test_source1 IS in list
</code></pre>

<h2>Comprehensive Testing (30 minutes)</h2>

<h3>Setup Test Environment</h3>

<pre><code># Create test directory structure
mkdir -p test_environment
cd test_environment

# Create multiple test sources
cat &gt; test_sources.yml &lt;&lt;EOF
test1:
  display_name: &quot;Test Source 1&quot;
  category: tech
test2:
  display_name: &quot;Test Source 2&quot;
  category: news
test3:
  display_name: &quot;Test Source 3&quot;
  category: tech
EOF
</code></pre>

<h3>Test 1: Batch Removal</h3>

<pre><code># 1. Create batch file
cat &gt; remove_batch.txt &lt;&lt;EOF
# Test batch removal
test1
test2
# test3 - keep this one
EOF

# 2. Preview batch
./capcat remove-source --batch remove_batch.txt --dry-run

# Expected:
# - Shows 2 sources (test1, test2)
# - [DRY RUN] message
# - No actual removal

# 3. Execute batch
./capcat remove-source --batch remove_batch.txt

# Expected:
# - Shows summary for test1, test2
# - Confirmation prompt
# - Backup created
# - Both sources removed

# 4. Verify
./capcat list sources | grep test

# Expected:
# - Only test3 appears
</code></pre>

<h3>Test 2: Analytics Integration</h3>

<pre><code># 1. Add test source
./capcat add-source --url https://feeds.example.com/test

# 2. Fetch from it several times to generate analytics
./capcat fetch test_analytics --count 5

# 3. Check analytics before removal
./capcat remove-source

# Expected:
# - Analytics summary shows test_analytics usage
# - Shows fetch count, frequency
# - Shows recommendation based on usage
</code></pre>

<h3>Test 3: Backup System</h3>

<pre><code># 1. Check backup directory
ls -la ../.capcat_backups/

# Expected:
# - Directory exists
# - Contains removal_* subdirectories

# 2. Inspect a backup
ls -la ../.capcat_backups/removal_*/

# Expected:
# - metadata.json
# - configs/ directory
# - bundles.yml

# 3. Check metadata
cat ../.capcat_backups/removal_*/metadata.json

# Expected:
# - JSON with backup_id, timestamp, sources
</code></pre>

<h3>Test 4: Force Mode (No Confirmations)</h3>

<pre><code># 1. Create batch file
echo &quot;test1&quot; &gt; force_test.txt

# 2. Execute with force
./capcat remove-source --batch force_test.txt --force

# Expected:
# - No confirmation prompts
# - Immediate removal
# - Backup still created
</code></pre>

<h3>Test 5: No Backup Mode</h3>

<pre><code># 1. Count current backups
BEFORE=$(ls ../.capcat_backups/ | wc -l)

# 2. Remove without backup
./capcat remove-source --no-backup

# Expected:
# - Normal removal process
# - No &quot;Backup created&quot; message

# 3. Verify no new backup
AFTER=$(ls ../.capcat_backups/ | wc -l)
[ &quot;$BEFORE&quot; -eq &quot;$AFTER&quot; ] &amp;&amp; echo &quot;PASS: No backup created&quot;
</code></pre>

<h3>Test 6: Multiple Undo/Restore</h3>

<pre><code># 1. Remove source A
./capcat remove-source  # Remove source A

# 2. Remove source B
./capcat remove-source  # Remove source B

# 3. List backups
./capcat remove-source --undo
# Cancel to just see list

# Expected:
# - Shows 2+ backups
# - Most recent first
# - Each with timestamp and sources

# 4. Restore specific backup
./capcat remove-source --undo removal_YYYYMMDD_HHMMSS

# Expected:
# - Restores only that specific backup&#x27;s sources
</code></pre>

<h2>Unit Testing</h2>

<h3>Test Analytics</h3>

<pre><code>cd Application

# Create test file
cat &gt; test_analytics_manual.py &lt;&lt;&#x27;EOF&#x27;
from pathlib import Path
from core.source_system.source_analytics import SourceAnalytics, AnalyticsReporter

# Test analytics tracking
analytics = SourceAnalytics(Path(&quot;/tmp/test_analytics.json&quot;))

# Record some fetches
analytics.record_fetch(&quot;test1&quot;, True, 10)
analytics.record_fetch(&quot;test1&quot;, True, 8)
analytics.record_fetch(&quot;test1&quot;, False, 0)

# Get stats
stats = analytics.get_source_stats(&quot;test1&quot;, &quot;Test Source 1&quot;)
print(f&quot;Total fetches: {stats.total_fetches}&quot;)
print(f&quot;Success rate: {stats.successful_fetches}/{stats.total_fetches}&quot;)
print(f&quot;Frequency: {stats.fetch_frequency}&quot;)

# Get recommendation
recommendation = AnalyticsReporter.format_removal_recommendation(stats)
print(f&quot;Recommendation: {recommendation}&quot;)
EOF

python test_analytics_manual.py

# Expected:
# Total fetches: 3
# Success rate: 2/3
# Frequency: ...
# Recommendation: [ACTIVE] Regular use
</code></pre>

<h3>Test Backup Manager</h3>

<pre><code>cat &gt; test_backup_manual.py &lt;&lt;&#x27;EOF&#x27;
from pathlib import Path
from core.source_system.source_backup_manager import SourceBackupManager

# Create test files
test_dir = Path(&quot;/tmp/test_capcat&quot;)
test_dir.mkdir(exist_ok=True)

config_path = test_dir / &quot;test.yml&quot;
config_path.write_text(&quot;display_name: Test&quot;)

bundles_path = test_dir / &quot;bundles.yml&quot;
bundles_path.write_text(&quot;bundles:\n  tech:\n    sources: [test]&quot;)

# Test backup
backup_manager = SourceBackupManager(test_dir / &quot;backups&quot;)
metadata = backup_manager.create_backup(
    [&quot;test&quot;],
    [config_path],
    bundles_path
)

print(f&quot;Backup created: {metadata.backup_id}&quot;)
print(f&quot;Sources: {metadata.sources}&quot;)

# Test restore
restored = backup_manager.restore_backup(
    metadata.backup_id,
    test_dir / &quot;restored&quot;,
    test_dir / &quot;bundles_restored.yml&quot;
)

print(f&quot;Restored: {restored}&quot;)

# List backups
backups = backup_manager.list_backups()
print(f&quot;Total backups: {len(backups)}&quot;)
EOF

python test_backup_manual.py

# Expected:
# Backup created: removal_YYYYMMDD_HHMMSS
# Sources: [&#x27;test&#x27;]
# Restored: [&#x27;test&#x27;]
# Total backups: 1
</code></pre>

<h2>Automated Test Suite</h2>

<pre><code># Run existing tests
pytest tests/test_remove_source_command.py -v
pytest tests/test_bundle_manager_remove.py -v

# Expected:
# All tests pass
# Coverage &gt; 90%
</code></pre>

<h3>Create New Test File</h3>

<pre><code>cat &gt; tests/test_enhanced_remove.py &lt;&lt;&#x27;EOF&#x27;
import pytest
from pathlib import Path
from unittest.mock import Mock

from core.source_system.enhanced_remove_command import (
    EnhancedRemoveCommand,
    RemovalOptions
)
from core.source_system.removal_ui import MockRemovalUI


def test_dry_run_mode():
    &quot;&quot;&quot;Test that dry-run doesn&#x27;t modify anything.&quot;&quot;&quot;
    # Setup
    base_command = Mock()
    backup_manager = Mock()
    analytics = Mock()
    ui = MockRemovalUI({&#x27;selected_sources&#x27;: [&#x27;test&#x27;], &#x27;confirm_removal&#x27;: True})

    command = EnhancedRemoveCommand(
        base_command, backup_manager, analytics, ui, Mock()
    )

    # Execute with dry-run
    options = RemovalOptions(dry_run=True)
    command.execute_with_options(options)

    # Verify nothing was actually removed
    base_command._remove_sources.assert_not_called()
    backup_manager.create_backup.assert_not_called()


def test_backup_created_by_default():
    &quot;&quot;&quot;Test that backup is created by default.&quot;&quot;&quot;
    # Setup mocks
    base_command = Mock()
    base_command._source_lister.get_available_sources.return_value = []

    # Should not reach backup creation with no sources
    # This tests the flow


def test_undo_latest():
    &quot;&quot;&quot;Test undoing the latest removal.&quot;&quot;&quot;
    # Test implementation
    pass
EOF

# Run new tests
pytest tests/test_enhanced_remove.py -v
</code></pre>

<h2>Integration Testing</h2>

<h3>Test Full Workflow</h3>

<pre><code>#!/bin/bash
# integration_test.sh

set -e  # Exit on error

echo &quot;=== Integration Test: Remove-Source Enhanced ===&quot;

# 1. Setup
echo &quot;Setting up test environment...&quot;
cd Application
source venv/bin/activate

# 2. Add test sources
echo &quot;Adding test sources...&quot;
# (Would need to be interactive or mocked)

# 3. Test dry-run
echo &quot;Testing dry-run...&quot;
./capcat remove-source --dry-run --no-analytics &lt;&lt; EOF
test1
n
EOF

# 4. Test actual removal
echo &quot;Testing removal with backup...&quot;
./capcat remove-source &lt;&lt; EOF
test1
y
EOF

# 5. Verify backup created
echo &quot;Verifying backup...&quot;
if [ -d &quot;../.capcat_backups&quot; ]; then
    echo &quot;PASS: Backup directory exists&quot;
else
    echo &quot;FAIL: No backup directory&quot;
    exit 1
fi

# 6. Test undo
echo &quot;Testing undo...&quot;
./capcat remove-source --undo &lt;&lt; EOF
y
EOF

# 7. Verify restore
echo &quot;Verifying restore...&quot;
./capcat list sources | grep test1 &amp;&amp; echo &quot;PASS: Source restored&quot; || echo &quot;FAIL: Source not found&quot;

echo &quot;=== All integration tests passed ===&quot;
</code></pre>

<h2>Edge Cases to Test</h2>

<h3>1. Empty Selections</h3>
<pre><code>./capcat remove-source

# Select nothing
# Expected: &quot;No sources selected for removal&quot;
</code></pre>

<h3>2. Non-Existent Source in Batch</h3>
<pre><code>echo &quot;nonexistent_source&quot; &gt; bad_batch.txt
./capcat remove-source --batch bad_batch.txt

# Expected:
# &quot;Sources not found: nonexistent_source&quot;
# &quot;No valid sources to remove&quot;
</code></pre>

<h3>3. Corrupted Backup</h3>
<pre><code># Manually corrupt a backup
echo &quot;bad data&quot; &gt; ../.capcat_backups/removal_test/metadata.json

# Try to restore
./capcat remove-source --undo removal_test

# Expected:
# Error message about corrupted backup
</code></pre>

<h3>4. Concurrent Operations</h3>
<pre><code># Terminal 1
./capcat remove-source

# Terminal 2 (while Terminal 1 is waiting for input)
./capcat remove-source

# Expected:
# Both should work independently
# File locking prevents corruption
</code></pre>

<h3>5. Disk Full Scenario</h3>
<pre><code># Simulate disk full (on test system only!)
# Expected: Graceful error handling
</code></pre>

<h2>Performance Testing</h2>

<h3>Large Batch Removal</h3>
<pre><code># Create 100 test sources (scripted)
# Remove all via batch
time ./capcat remove-source --batch large_batch.txt --force

# Expected:
# - Completes in &lt; 5 seconds
# - Single backup contains all sources
</code></pre>

<h3>Analytics with Many Records</h3>
<pre><code># Simulate 1000 fetch records
# Check analytics query performance
time ./capcat remove-source --dry-run

# Expected:
# - Analytics load &lt; 1 second
# - No performance degradation
</code></pre>

<h2>Checklist</h2>

<h3>Basic Functionality</h3>
<ul>
<li>[ ] Interactive removal works</li>
<li>[ ] Sources actually deleted</li>
<li>[ ] Bundles updated correctly</li>
<li>[ ] Registry refreshed</li>
</ul>

<h3>Dry-Run Mode</h3>
<ul>
<li>[ ] No files deleted in dry-run</li>
<li>[ ] Preview shows correct information</li>
<li>[ ] Can execute after dry-run</li>
</ul>

<h3>Backup System</h3>
<ul>
<li>[ ] Backup created automatically</li>
<li>[ ] Backup contains all files</li>
<li>[ ] Metadata saved correctly</li>
<li>[ ] Can skip backup with flag</li>
</ul>

<h3>Analytics</h3>
<ul>
<li>[ ] Usage stats displayed</li>
<li>[ ] Recommendations shown</li>
<li>[ ] Can skip with flag</li>
<li>[ ] Analytics persist across sessions</li>
</ul>

<h3>Batch Removal</h3>
<ul>
<li>[ ] Batch file parsed correctly</li>
<li>[ ] Comments ignored</li>
<li>[ ] Invalid sources reported</li>
<li>[ ] Multiple sources removed</li>
</ul>

<h3>Undo/Restore</h3>
<ul>
<li>[ ] Lists available backups</li>
<li>[ ] Restores files correctly</li>
<li>[ ] Registry refreshed after restore</li>
<li>[ ] Can specify backup ID</li>
</ul>

<h3>Error Handling</h3>
<ul>
<li>[ ] Invalid source IDs handled</li>
<li>[ ] Missing files handled gracefully</li>
<li>[ ] User cancellation works</li>
<li>[ ] Partial failures continue</li>
</ul>

<h3>CLI Integration</h3>
<ul>
<li>[ ] All flags work</li>
<li>[ ] Flag combinations work</li>
<li>[ ] Help text accurate</li>
<li>[ ] Exit codes correct</li>
</ul>

<h2>Troubleshooting Tests</h2>

<h3>Test Fails: &quot;Module not found&quot;</h3>
<pre><code># Ensure in venv
source venv/bin/activate

# Install dependencies
pip install -r requirements.txt
</code></pre>

<h3>Test Fails: &quot;Permission denied&quot;</h3>
<pre><code># Check directory permissions
ls -la ../.capcat_backups/

# Fix if needed
chmod 755 ../.capcat_backups/
</code></pre>

<h3>Test Fails: &quot;No backups found&quot;</h3>
<pre><code># Create a backup first
./capcat remove-source  # Remove something

# Then test undo
./capcat remove-source --undo
</code></pre>

<h2>Continuous Testing</h2>

<pre><code># Run all tests
pytest tests/ -v --cov=core.source_system

# Expected coverage:
# - source_backup_manager.py &gt; 90%
# - source_analytics.py &gt; 90%
# - enhanced_remove_command.py &gt; 85%
# - remove_source_command.py &gt; 95%
</code></pre>

<script type="module">
  import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
    mermaid.initialize({
    startOnLoad: true,
    theme: 'base',
    themeVariables: {
      // Primary colors from design system (Capcat orange palette)
      primaryColor: '#FFD4B7',           // --orange-200
      primaryTextColor: '#201419',       // --ink
      primaryBorderColor: '#F1540E',     // --orange-500 / --accent-primary

      // Line and edge colors
      lineColor: '#58444c',              // --ink-medium

      // Secondary colors
      secondaryColor: '#FFEADB',         // --orange-100
      tertiaryColor: '#f9f8ed',          // --accent-cream-primary

      // Text colors
      textColor: '#201419',              // --ink
      mainBkg: '#FAF8EE',                // --cream

      // Node styling
      nodeBorder: '#F1540E',             // --accent-primary
      clusterBkg: '#faf2e7',             // --accent-cream-light
      clusterBorder: '#D44400',          // --orange-600 / --accent-hover

      // Font
      fontFamily: '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif',
      fontSize: '16px'
    },
    flowchart: {
      nodeSpacing: 50,
      rankSpacing: 50,
      padding: 15,
      useMaxWidth: true,
      htmlLabels: true,
      curve: 'basis'
    }
  });

  // Add copy buttons to Mermaid diagrams after rendering
  document.addEventListener('DOMContentLoaded', function() {
    const mermaidDivs = document.querySelectorAll('.mermaid');

    mermaidDivs.forEach(function(mermaidDiv) {
      // Get the original Mermaid source code
      const mermaidSource = mermaidDiv.textContent;

      // Create container wrapper
      const container = document.createElement('div');
      container.className = 'mermaid-container';

      // Create copy button
      const copyBtn = document.createElement('button');
      copyBtn.className = 'mermaid-copy-btn';
      copyBtn.textContent = 'Copy Mermaid Code';
      copyBtn.setAttribute('title', 'Copy diagram code for Draw.io, Mermaid Live, etc.');

      copyBtn.addEventListener('click', function() {
        navigator.clipboard.writeText(mermaidSource).then(function() {
          copyBtn.textContent = 'Copied!';
          copyBtn.classList.add('copied');

          setTimeout(function() {
            copyBtn.textContent = 'Copy Mermaid Code';
            copyBtn.classList.remove('copied');
          }, 2000);
        });
      });

      // Wrap the mermaid div in container and add button
      mermaidDiv.parentNode.insertBefore(container, mermaidDiv);
      container.appendChild(mermaidDiv);
      container.appendChild(copyBtn);
    });
  });
</script>
    
    
    <script src="../js/main.js"></script>

            </div>
        </div>
    </div>

    <!-- Footer -->
    <div id="footer-placeholder"></div>

    <!-- Back to Top Button -->
    <button id="backToTopBtn" title="Go to top">
        <svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 0 24 24" width="24">
            <path d="M0 0h24v24H0V0z" fill="none"/>
            <path fill="currentColor" d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6 1.41 1.41z"/>
        </svg>
    </button>

    <script src="../../js/includes-loader.js"></script>
  </body>
