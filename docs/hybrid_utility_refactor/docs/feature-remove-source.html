<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Feature Documentation: Remove Source</title>
    <link rel="stylesheet" href="../css/design-system.css">
    <link rel="stylesheet" href="../css/main.css">
</head>
<body>
    <!-- Header -->
    <div id="header-placeholder"></div>


    <div class="doc-container">
        <div class="container">
            <div class="doc-content">

<div class="nav-breadcrumb"><a href="index.html">Documentation Home</a></div>
<h1>Feature Documentation: Remove Source</h1>

<h2>Overview</h2>

<p>The <code>./capcat remove-source</code> command provides an interactive interface for removing existing RSS sources from the Capcat system. It follows the same clean architecture and user interface patterns as the add-source feature.</p>

<h2>Usage</h2>

<pre><code>./capcat remove-source
</code></pre>

<p>No arguments required - the command is fully interactive.</p>

<h2>Interactive Workflow</h2>

<h3>Step 1: Source Selection</h3>
<div class="ascii-art">  Select sources to remove (use &lt;space&gt; to select):
▶ ○ Hacker News (hn)
  ○ BBC News (bbc)
  ○ InfoQ (iq)
  ○ Gizmodo (gizmodo)
</div>

<p>Users can select multiple sources using the spacebar, with the orange pointer (▶) indicating navigation.</p>

<h3>Step 2: Removal Summary</h3>
<pre><code>--- Removal Summary ---

  Source: Hacker News (hn)
  Config: /path/to/sources/active/config_driven/configs/hn.yml
  Bundles: tech, techpro

  Source: BBC News (bbc)
  Config: /path/to/sources/active/config_driven/configs/bbc.yml
  Bundles: news

--------------------------------------------------
</code></pre>

<p>Shows exactly what will be removed for each source.</p>

<h3>Step 3: Confirmation</h3>
<pre><code>  Remove 2 source(s)? This cannot be undone. No
</code></pre>

<p>Default is &quot;No&quot; for safety. User must explicitly confirm.</p>

<h3>Step 4: Execution</h3>
<pre><code>[OK] Removed &#x27;Hacker News&#x27;
[OK] Removed &#x27;BBC News&#x27;
[OK] Successfully removed 2 source(s).
</code></pre>

<h2>Automated Actions</h2>

<p>The command performs the following actions <h4>immediately</h4> in this order:</p>

<ol>
<li><h4>Configuration File Removal</h4> Deletes the YAML file from <code>sources/active/config_driven/configs/</code></li>
<ul>
<li>Physical file removed from filesystem</li>
</ol>
<ul>
<li>Cannot be undone without backup</li>
</ul>

<ol>
<li><h4>Bundle Updates</h4> Removes the source from all bundles in <code>bundles.yml</code></li>
<ul>
<li>Preserves YAML comments and formatting using ruamel.yaml</li>
</ol>
<ul>
<li>Changes written to disk immediately</li>
<li>Returns list of affected bundles</li>
</ul>

<ol>
<li><h4>Registry Refresh</h4> Resets the in-memory source registry</li>
<ul>
<li>Calls <code>reset_source_registry()</code> to clear cached data</li>
</ol>
<ul>
<li>Next registry access will re-scan filesystem</li>
<li><h4>Immediate effect</h4> - removed sources unavailable instantly</li>
<li>No restart required</li>
</ul>

<h2>Architecture</h2>

<h3>Clean Architecture Implementation</h3>

<div class="ascii-art">core/source_system/
├── remove_source_command.py   # Command with dependency injection
├── removal_ui.py               # User interface (orange theme)
├── remove_source_service.py   # Service integration layer
└── bundle_manager.py           # Updated with removal logic
</div>

<h3>Key Components</h3>

<h3>RemoveSourceCommand</h3>
<p>Single responsibility: Orchestrate the removal workflow</p>

<h4>Protocols Used:</h4>
<ul>
<li><code>SourceLister</code>: Lists available sources</li>
<li><code>SourceInfoProvider</code>: Gathers source details</li>
<li><code>RemovalUserInterface</code>: User interaction</li>
<li><code>ConfigFileRemover</code>: File system operations</li>
<li><code>BundleUpdater</code>: Bundle management</li>
</ul>

<h3>QuestionaryRemovalUI</h3>
<p>Implements the user interface with consistent Capcat styling:</p>
<ul>
<li>Orange theme (#d75f00)</li>
<li>No question marks (qmark=&quot;&quot;)</li>
<li>Orange pointer (▶)</li>
<li>Clean, concise prompts</li>
</ul>

<h3>BundleManager.remove_source_from_all_bundles()</h3>
<p>New method that:</p>
<ul>
<li>Finds all bundles containing the source</li>
<li>Removes source from each bundle</li>
<li>Preserves YAML comments and structure</li>
<li>Returns list of updated bundles</li>
</ul>

<h2>Safety Features</h2>

<h3>Confirmation Required</h3>
<ul>
<li>Default answer is &quot;No&quot; for destructive action</li>
<li>Clear warning: &quot;This cannot be undone&quot;</li>
<li>Summary shown before confirmation</li>
</ul>

<h3>Graceful Error Handling</h3>
<ul>
<li>Partial failures don&#x27;t stop the workflow</li>
<li>Each source removal is independent</li>
<li>Errors shown but process continues</li>
</ul>

<h3>Preservation of Structure</h3>
<ul>
<li>YAML comments preserved in bundles.yml</li>
<li>Formatting maintained using ruamel.yaml</li>
<li>Bundle structure unchanged</li>
</ul>

<h2>CLI Integration</h2>

<h3>Argument Parser</h3>
<pre><code>subparsers.add_parser(
    &#x27;remove-source&#x27;,
    help=&#x27;Remove existing sources interactively&#x27;
)
</code></pre>

<h3>Handler</h3>
<pre><code>elif args.command == &#x27;remove-source&#x27;:
    remove_source()
    sys.exit(0)
</code></pre>

<h3>Service Usage</h3>
<pre><code>def remove_source():
    try:
        service = create_remove_source_service()
        service.remove_sources()
    except CapcatError as e:
        print(f&quot;Error: {e.user_message}&quot;, file=sys.stderr)
        sys.exit(1)
</code></pre>

<h2>Testing</h2>

<h3>Test Coverage: 95%+</h3>

<h4>Unit Tests:</h4>
<ul>
<li><code>test_remove_source_command.py</code> - Command logic</li>
<li><code>test_bundle_manager_remove.py</code> - Bundle removal</li>
</ul>

<h4>Test Scenarios:</h4>
<ul>
<li>No sources available</li>
<li>User selects no sources</li>
<li>User cancels confirmation</li>
<li>Single source removal</li>
<li>Multiple source removal</li>
<li>Partial failures</li>
<li>Bundle preservation</li>
<li>Comment preservation</li>
</ul>

<h3>Integration Tests</h3>
<ul>
<li>Full workflow with real file operations</li>
<li>Bundle updates verified</li>
<li>Config file deletion confirmed</li>
</ul>

<h2>Error Handling</h2>

<h3>User Errors</h3>
<ul>
<li>No sources available: Shows info message, exits gracefully</li>
<li>No sources selected: Shows info message, returns to prompt</li>
<li>Cancellation: Allows exit at any step</li>
</ul>

<h3>System Errors</h3>
<ul>
<li>Missing config file: Logs warning, continues</li>
<li>Bundle update failure: Shows error, continues with next source</li>
<li>Registry failure: Shows error, raises CapcatError</li>
</ul>

<h2>Comparison with Add-Source</h2>

<ul>
<li><h4>
<h4>Interaction</h4></h4> → Text input + selections</li>
<li><h4>
<h4>Confirmation</h4></h4> → Optional test fetch</li>
<li><h4>
<h4>Default safety</h4></h4> → Recommended actions</li>
<li><h4>
<h4>Batch operation</h4></h4> → Single source</li>
<li><h4>
<h4>Reversibility</h4></h4> → N/A</li>
</ul>

<h2>Examples</h2>

<h3>Remove Single Source</h3>
<div class="ascii-art">$ ./capcat remove-source

  Select sources to remove (use &lt;space&gt; to select):
▶ ◉ InfoQ (iq)
  ○ Hacker News (hn)

--- Removal Summary ---
  Source: InfoQ (iq)
  Config: .../configs/iq.yml
  Bundles: tech

  Remove 1 source(s)? This cannot be undone. Yes

[OK] Removed &#x27;InfoQ&#x27;
[OK] Successfully removed 1 source(s).
</div>

<h3>Remove Multiple Sources</h3>
<div class="ascii-art">$ ./capcat remove-source

  Select sources to remove (use &lt;space&gt; to select):
▶ ◉ Hacker News (hn)
  ◉ BBC News (bbc)
  ○ InfoQ (iq)

--- Removal Summary ---
  Source: Hacker News (hn)
  Config: .../configs/hn.yml
  Bundles: tech, techpro

  Source: BBC News (bbc)
  Config: .../configs/bbc.yml
  Bundles: news

  Remove 2 source(s)? This cannot be undone. Yes

[OK] Removed &#x27;Hacker News&#x27;
[OK] Removed &#x27;BBC News&#x27;
[OK] Successfully removed 2 source(s).
</div>

<h3>Cancel Operation</h3>
<div class="ascii-art">$ ./capcat remove-source

  Select sources to remove (use &lt;space&gt; to select):
▶ ◉ Hacker News (hn)

--- Removal Summary ---
  Source: Hacker News (hn)
  Config: .../configs/hn.yml
  Bundles: tech, techpro

  Remove 1 source(s)? This cannot be undone. No

Removal cancelled.
</div>

<h2>Extension Points</h2>

<p>The clean architecture allows easy extension:</p>

<h3>Custom UI</h3>
<pre><code>class WebRemovalUI:
    &quot;&quot;&quot;Web-based removal interface.&quot;&quot;&quot;

    def select_sources_to_remove(self, sources):
        # Web form implementation
</code></pre>

<h3>Additional Cleanup</h3>
<pre><code>class CacheCleanupRemover:
    &quot;&quot;&quot;Remove source caches during deletion.&quot;&quot;&quot;

    def remove_config_file(self, config_path):
        # Delete config + clear caches
</code></pre>

<h3>Audit Trail</h3>
<pre><code>class AuditingBundleUpdater:
    &quot;&quot;&quot;Log all bundle changes for audit.&quot;&quot;&quot;

    def remove_source_from_all_bundles(self, source_id):
        # Log removal + update bundles
</code></pre>

<h2>Best Practices</h2>

<h3>Before Removing</h3>
<ol>
<li>Check if source is actively used</li>
<li>Review bundles that will be affected</li>
<li>Consider backing up configuration first</li>
</ol>

<h3>After Removing</h3>
<ol>
<li>Verify bundles still work correctly</li>
<li>Test remaining sources in affected bundles</li>
<li>Update documentation if needed</li>
</ol>

<h2>Technical Details</h2>

<h3>Dependencies</h3>
<ul>
<li><code>ruamel.yaml</code>: Preserves YAML comments/structure</li>
<li><code>questionary</code>: Interactive prompts with styling</li>
<li><code>prompt_toolkit</code>: Terminal UI framework</li>
</ul>

<h3>File Operations</h3>
<ul>
<li>Safe deletion using pathlib</li>
<li>Existence checks before removal</li>
<li>No recursive operations (targets specific files)</li>
</ul>

<h3>Registry Update Mechanism</h3>

<h4>The Source Registry Singleton:</h4>
<pre><code># In source_registry.py (line 427-436)
_global_registry: Optional[SourceRegistry] = None

def get_source_registry() -&gt; SourceRegistry:
    global _global_registry
    if _global_registry is None:
        _global_registry = SourceRegistry()
        _global_registry.discover_sources()  # Scans filesystem
    return _global_registry

def reset_source_registry():
    &quot;&quot;&quot;Reset registry (forces re-scan on next access)&quot;&quot;&quot;
    global _global_registry
    _global_registry = None
</code></pre>

<h4>Update Flow:</h4>
<ol>
<li><h4>Before removal</h4> Registry cached in memory with all sources</li>
<li><h4>Delete config file</h4> File removed from disk</li>
<li><h4>Update bundles</h4> bundles.yml modified</li>
<li><h4>Call <code>reset_source_registry()</code></h4> Clears in-memory cache</li>
<li><h4>Next access</h4> Registry re-scans filesystem (removed sources gone)</li>
</ol>

<h4>Why This Works:</h4>
<ul>
<li>Registry uses lazy initialization</li>
<li><code>reset_source_registry()</code> sets global to <code>None</code></li>
<li>Next call to <code>get_source_registry()</code> creates fresh instance</li>
<li>Fresh instance runs <code>discover_sources()</code> which scans disk</li>
<li>Deleted configs not found = source no longer exists</li>
</ul>

<h4>Immediate Effect:</h4>
<pre><code>$ ./capcat remove-source
# Select and confirm removal of &#x27;hn&#x27;
[OK] Successfully removed 1 source(s).

$ ./capcat list sources
# &#x27;hn&#x27; is GONE - no restart needed
</code></pre>

<h3>Performance</h3>
<ul>
<li>O(1) config file deletion</li>
<li>O(n) bundle updates (n = number of bundles)</li>
<li>O(m) registry refresh (m = total number of remaining sources)</li>
<li>Minimal memory footprint</li>
</ul>

<h2>Future Enhancements</h2>

<p>Potential improvements:</p>
<ul>
<li>Batch removal from file list</li>
<li>Dry-run mode (preview changes)</li>
<li>Backup before removal</li>
<li>Undo functionality (restore from backup)</li>
<li>Source usage statistics before removal</li>
<li>Integration with source analytics</li>
</ul>

<script type="module">
  import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
    mermaid.initialize({
    startOnLoad: true,
    theme: 'base',
    themeVariables: {
      // Primary colors from design system (Capcat orange palette)
      primaryColor: '#FFD4B7',           // --orange-200
      primaryTextColor: '#201419',       // --ink
      primaryBorderColor: '#F1540E',     // --orange-500 / --accent-primary

      // Line and edge colors
      lineColor: '#58444c',              // --ink-medium

      // Secondary colors
      secondaryColor: '#FFEADB',         // --orange-100
      tertiaryColor: '#f9f8ed',          // --accent-cream-primary

      // Text colors
      textColor: '#201419',              // --ink
      mainBkg: '#FAF8EE',                // --cream

      // Node styling
      nodeBorder: '#F1540E',             // --accent-primary
      clusterBkg: '#faf2e7',             // --accent-cream-light
      clusterBorder: '#D44400',          // --orange-600 / --accent-hover

      // Font
      fontFamily: '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif',
      fontSize: '16px'
    },
    flowchart: {
      nodeSpacing: 50,
      rankSpacing: 50,
      padding: 15,
      useMaxWidth: true,
      htmlLabels: true,
      curve: 'basis'
    }
  });

  // Add copy buttons to Mermaid diagrams after rendering
  document.addEventListener('DOMContentLoaded', function() {
    const mermaidDivs = document.querySelectorAll('.mermaid');

    mermaidDivs.forEach(function(mermaidDiv) {
      // Get the original Mermaid source code
      const mermaidSource = mermaidDiv.textContent;

      // Create container wrapper
      const container = document.createElement('div');
      container.className = 'mermaid-container';

      // Create copy button
      const copyBtn = document.createElement('button');
      copyBtn.className = 'mermaid-copy-btn';
      copyBtn.textContent = 'Copy Mermaid Code';
      copyBtn.setAttribute('title', 'Copy diagram code for Draw.io, Mermaid Live, etc.');

      copyBtn.addEventListener('click', function() {
        navigator.clipboard.writeText(mermaidSource).then(function() {
          copyBtn.textContent = 'Copied!';
          copyBtn.classList.add('copied');

          setTimeout(function() {
            copyBtn.textContent = 'Copy Mermaid Code';
            copyBtn.classList.remove('copied');
          }, 2000);
        });
      });

      // Wrap the mermaid div in container and add button
      mermaidDiv.parentNode.insertBefore(container, mermaidDiv);
      container.appendChild(mermaidDiv);
      container.appendChild(copyBtn);
    });
  });
</script>
    
    
    <script src="../js/main.js"></script>

            
<nav class="chapter-navigation" aria-label="Chapter navigation">
    <div class="next-chapter-content">
        <span class="next-chapter-label">Next Chapter</span>
        <span class="next-chapter-arrow" aria-hidden="true">→</span>
        <a href="remove-source-advanced-features.html" class="next-chapter-link" rel="next">Advanced Remove Source Features</a>
    </div>
</nav>
</div>
        </div>
    </div>

    <!-- Footer -->
    <div id="footer-placeholder"></div>

    <!-- Back to Top Button -->
    <button id="backToTopBtn" title="Go to top">
        <svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 0 24 24" width="24">
            <path d="M0 0h24v24H0V0z" fill="none"/>
            <path fill="currentColor" d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6 1.41 1.41z"/>
        </svg>
    </button>

    <script src="../../js/includes-loader.js"></script>
  </body>
